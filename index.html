<!DOCTYPE html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
Callsigner
</title>
<script>

const PermittedCallsignLetters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
const PermittedLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
const PermittedNumbers = "1234567890";
const CallsignFormats = ["#####", "####A", "###AA"];
var Callsigns = {
"AAL":"AMERICAN",
"AAY":"ALLEGIANT",
"ASQ":"ACEY",
"JBU":"JETBLUE",
"DAL":"DELTA",
"FDX":"FEDEX",
"ENY":"ENVOY",
"FFT":"FRONTIER",
"A":"AIR FORCE",
"E":"AIR EVAC",
"G":"GUARD",
"RCH":"REACH",
"ASA":"ALASKA",
"RPA":"BRICKYARD",
"SWA":"SOUTHWEST",
"SKW":"SKYWEST",
"UAL":"UNITED",
"VM":"MARINE",
"VV":"NAVY",
"R":"ARMY",
"S":"SAM",
"EDV":"ENDEAVOR",
"JIA":"BLUESTREAK",
"JZA":"JAZZ",
"PDT":"PIEDMONT",
"EJA":"EXECJET"
};
var MilCallsigns = [
"AGONY",
"BALL",
"CANON",
"COBRA",
"DOOM",
"HOG",
"HORSE",
"IGLOO",
"JOKER",
"KING",
"LANCE",
"LAZER",
"LIFTR",
"NASA",
"NOMAD",
"OKIE",
"OSAGE",
"PACER",
"POLO",
"REESE",
"SHARK",
"SHEP",
"SNTRY",
"SOONR",
"VANDY",
"VIPER",
"WATCH"
]

ACFT_TYPES = [
"AEST",
"A319",
"A320",
"A332",
"A388",
"B190",
"B350",
"BE35",
"B350",
"BE36",
"BE20",
"BE30",
"BE40",
"BE55",
"BE58",
"BE60",
"BE76",
"B06",
"UH1",
"B52",
"B737",
"B738",
"B38M",
"B744",
"B752",
"B772",
"B762",
"C17",
"CH47",
"K35A",
"K35E",
"MD11",
"B763",
"B788",
"MD80",
"MD90",
"CL60",
"CRJ7",
"CRJ9",
"C152",
"C172",
"C177",
"C182",
"C206",
"C208",
"C210",
"C310",
"C337",
"C402",
"C414",
"C421",
"C441",
"C650",
"C750",
"F900",
"FA20",
"DH8D",
"DH8C",
"E145",
"E170",
"E175",
"E75S",
"E190",
"A10",
"LJ25",
"LJ31",
"LJ35",
"LJ55",
"LJ60",
"AA5",
"C2",
"GLF4",
"GLF5",
"C130",
"C5",
"C5A",
"F16",
"F15",
"F18",
"MU2",
"M20T",
"PC12",
"PA27",
"PAY1",
"PAY2",
"PAY3",
"PAY4",
"PA46",
"PA31",
"PA32",
"PA44",
"PA34",
"P28A",
"R22",
"AC50",
"B1",
"H60"
]

function randomElementOf(a) {
    let randomIndex = Math.floor(Math.random() * a.length);
    let val = a[randomIndex];
    return val;
}

function randomNumber() {
    return randomElementOf(PermittedNumbers);
}

function randomLetter() {
    return randomElementOf(PermittedLetters);
}

function randomCallsignLetter() {
    return randomElementOf(PermittedCallsignLetters);
}

var codeDiv = document.getElementById("an_code");
var codeAns = document.getElementById("an_answer");
var modeSelect = document.getElementById("an_select");
function loadSettings() {
    codeDiv = document.getElementById("an_code");
    codeAns = document.getElementById("an_answer");
    modeSelect = document.getElementById("an_select");
    if (localStorage['mode']) {
        modeSelect.value = localStorage['mode'];
    }
}

function saveSettings() {
    localStorage['mode'] = modeSelect.value;
}

function generateNewCode() {
    var newValue = "Technical Error";
    var type = Math.floor(Math.random() * 100);
    if (type > 50) {
        // Commercial callsign
        newValue = "";
        let format = randomElementOf(Object.keys(Callsigns));
        let number = Math.floor(Math.random() * 8999) + 1;
        newValue = format + number;
    } else if (type > 40) {
        // Mill callsign
        let format = randomElementOf(MilCallsigns);
        let number = Math.floor(Math.random() * 90) + 1;
        newValue = format + number;
    } else {
        // N number
        // Make new callsign
        let format = randomElementOf(CallsignFormats);
        newValue = "";
        for (let i = 0; i < format.length; i++) {
            let type = format[i];
            if (type == "A") {
                newValue += randomLetter();
            } else if (type == "#") {
                newValue += randomNumber(); // trim '0's from front later
            } else {
                console.error("Unknown format type");
            }
        }
        // Trim '0's
        while (newValue.length > 0 && newValue[0] == "0") {
            newValue = newValue.substring(1);
        }
        // Add 'N' and ensure not 0-length
        if (newValue.length == 0) {
            newValue = "N1";
        } else {
            newValue = "N" + newValue;
        }
    }

    var acft_type = randomElementOf(ACFT_TYPES);

    codeDiv.innerHTML = newValue + " " + acft_type + "<br />" + codeDiv.innerHTML;
}

function speakableAnswer(code, lookupType) {
    let dictionary = Lookup;
    if (lookupType != null && lookupType == 1) {
        dictionary = SpeakLookup;
    }
    // Produce an answer
    var answer = "";
    var issue = false;
    for (let char of code) {
        if (answer.length > 0) {
            answer += " ";
        }
        let lookup = dictionary[char];
        if (lookup == null) {
            issue = true;
        } else {
            answer += lookup;
        }
    }
    if (issue) {
        answer = "There was an error...";
    }
    return answer;
}
function showAnswer() {
    var value = modeSelect.value;
    var isCallsignPracticeMode = value == "np";
    if (codeAns.innerHTML.length == 0) {
        codeAns.innerHTML = speakableAnswer(codeDiv.innerHTML);
    }
    codeDiv.hidden = false;
}
function handleKeyUp(e) {
    if (e != null && e.keyCode == 13) {
        generateNewCode();
    } else {
        showAnswer();
    }
}

var HasAlertedNoEnUSVoice = false;
const synth = window.speechSynthesis;
let voices = [];

function speakCallsign(text) {
    if (synth.speaking) {
        return; // give up for now
    }
    const callsignPlayer = new SpeechSynthesisUtterance(text);

    let voiceSelect = document.getElementById("voice-select");
    const selectedOption =
      voiceSelect.selectedOptions[0].getAttribute("data-name");

    for (let i = 0; i < voices.length; i++) {
      if (voices[i].name === selectedOption) {
        callsignPlayer.voice = voices[i];
        break;
      }
    }
    callsignPlayer.pitch = 1.0;
    callsignPlayer.rate = 1.0;
    synth.speak(callsignPlayer);
}

function populateVoiceList() {
  voices = synth.getVoices().sort(function (a, b) {
    const aname = a.name.toUpperCase();
    const bname = b.name.toUpperCase();

    if (aname < bname) {
      return -1;
    } else if (aname == bname) {
      return 0;
    } else {
      return +1;
    }
  });
  let voiceSelect = document.getElementById("voice-select");
  var selectedIndex =
    voiceSelect.selectedIndex < 0 ? 0 : voiceSelect.selectedIndex;
  voiceSelect.innerHTML = "";

  var optionIndex = 0;
  for (let i = 0; i < voices.length; i++) {
    const option = document.createElement("option");
    let voice = voices[i];
    if (!voice.lang.startsWith("en")) {
        continue; // Only show en voices
    }
    option.textContent = `${voice.name} (${voice.lang})`;

    if (voices[i].default) {
      option.textContent += " -- DEFAULT";
    }
    if (voice.name == "Samantha") {
        selectedIndex = optionIndex;
    }

    option.setAttribute("data-lang", voice.lang);
    option.setAttribute("data-name", voice.name);
    voiceSelect.appendChild(option);
    optionIndex += 1;
  }

  voiceSelect.selectedIndex = selectedIndex;
}

if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = populateVoiceList;
}

function anSelectChanged() {
    generateNewCode();
    saveSettings();
}

function onloadCallback() {
    loadSettings();
    populateVoiceList();
}
</script>
<style>
* {
	margin:0;
	padding:0;
}
html {
	height:100%;
	width:100%;
}
body {
    height: 100%;
    width: 100%;
}
#content {
    width: 100%;
    margin: 0 auto;
}
.controls {
    display: flex;
    justify-content: center;
    align-items: center;
}
#an_code {
    min-height: 100px;
    font-size: clamp(4rem, 4.5vw, 8rem);
    height: clamp(4rem, 4.5vw, 8rem);
    text-align: center;
    vertical-align: middle;
}
#an_answer {
    text-align: center;
    min-height: 200px;
    font-size: clamp(2rem, 2.5vw, 4rem);
    height: clamp(2rem, 2.5vw, 4rem);
}

button {
    padding: 10px;
    margin: 10px;
}
</style>
</head>

<body onkeyup="handleKeyUp(event)" onload="onloadCallback()">
Press enter for "Next"<br />
<div class="controls">
<button onclick="generateNewCode()">Next</button>
</div>
<div id="content">
<div id="an_code">ABCDEF</div>
<div id="an_answer"></div>

<div class="controls">

</div>

</div>
</body>

</html>